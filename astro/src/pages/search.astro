---
import Layout from "../layouts/Layout.astro";
import PageHeader from "../components/PageHeader.astro";
import { SearchResultItem, type SearchResultPost } from "../components/SearchResultItem.tsx";
import { extractSnippet } from "../../../shared/services/snippet.ts";
import { Index } from "flexsearch";
import data from "../../../data.json";

// Get search query from URL parameters
const url = new URL(Astro.request.url);
const q = url.searchParams.get("q");

let searchResults: SearchResultPost[] = [];
let status: "no-query" | "no-results" | "success" = "no-query";

if (q && q.trim()) {
  // Initialize FlexSearch index
  const index = new Index({
    preset: "memory",
    tokenize: "full",
  });

  // Index all posts (optimize by caching valid posts)
  const validPosts = data.filter((post) => post.createdAt);
  
  // Batch index operations for better performance
  validPosts.forEach((post, i) => {
    const content = `${post.title} ${post.body}`;
    index.add(i, content);
  });

  // Search and get results with proper limit
  const searchResultIds = index.search(q, { limit: 10 }) as number[];
  
  if (searchResultIds.length > 0) {
    status = "success";
    
    searchResults = searchResultIds.map((resultId) => {
      const post = validPosts[resultId];
      
      // Extract snippet
      const titleText = post.title;
      const bodyText = post.body;
      let snippet = "";

      // First try to find the keyword in the title
      if (titleText.toLowerCase().includes(q.toLowerCase())) {
        snippet = extractSnippet(titleText, q, 100);
      }

      // If no title match or title snippet is too short, try body
      if (!snippet || snippet.length < 20) {
        const bodySnippet = extractSnippet(bodyText, q);
        if (bodySnippet) {
          snippet = bodySnippet;
        }
      }

      return {
        id: post.id,
        title: post.title,
        createdAt: post.createdAt === null ? null : new Date(post.createdAt),
        snippet,
      };
    }).filter((result) => result.createdAt !== null) as SearchResultPost[];
  } else {
    status = "no-results";
  }
}
---

<Layout title={q ? `"${q}" 검색 결과` : "검색"}>
  <PageHeader searchQuery={q || ""} />

  <!-- Search Results -->
  <div class="w-full flex justify-center">
    <div class="max-w-[680px]">
      {status === "no-query" && (
        <div class="text-center py-16">
          <div class="max-w-md mx-auto">
            <h2 class="text-xl font-medium text-gray-900 mb-2">검색을 시작해보세요</h2>
            <p class="text-gray-600">
              찾고 싶은 내용의 키워드를 입력해 주세요.
            </p>
          </div>
        </div>
      )}

      {status === "no-results" && (
        <div class="text-center py-16">
          <div class="max-w-md mx-auto">
            <h2 class="text-xl font-medium text-gray-900 mb-2">
              "<span class="text-blue-600">{q}</span>" 검색 결과가 없습니다
            </h2>
            <p class="text-gray-600">다른 검색어를 시도해 보세요.</p>
          </div>
        </div>
      )}

      {status === "success" && (
        <div>
          <div class="mb-8">
            <h2 class="text-lg font-medium text-gray-900 mb-1">
              "<span class="text-blue-600">{q}</span>" 검색 결과
            </h2>
            <p class="text-sm text-gray-500">{searchResults.length}개 발견</p>
          </div>
          
          <div class="space-y-6">
            {searchResults.map((result) => (
              <SearchResultItem post={result} />
            ))}
          </div>
        </div>
      )}
    </div>
  </div>
</Layout>